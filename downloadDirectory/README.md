<h2>Download Directory</h2>

The Download Directory step generates a number of files that can be downloaded from Reactome's <a href="https://reactome.org/download-data">download page</a>. It also generates an archive file during the `CreateReleaseTarball` step that acts as a snapshot of the <a href="https://github.com/reactome/Release">Release repository</a> and release server. This module has been rewritten from Perl to Java. 
<br><br>The steps of DownloadDirectory and files produced are:

- <a href="https://github.com/reactome/data-release-pipeline/tree/feature/download-directory/downloadDirectory#databasedumps">DatabaseDumps</a>: `gk_stable_ids.sql`, `gk_current.sql`
- <a href="https://github.com/reactome/data-release-pipeline/tree/feature/download-directory/downloadDirectory#biopax">BioPAX</a>: `biopax2.zip`, `biopax2_validator.zip`, `biopax.zip`, `biopax_validator.zip`
- <a href="https://github.com/reactome/data-release-pipeline/tree/feature/download-directory/downloadDirectory#gseaoutput">GSEAOutput</a>: `ReactomePathways.gmt.zip`
- <a href="https://github.com/reactome/data-release-pipeline/tree/feature/download-directory/downloadDirectory#reactomebook">ReactomeBook</a>: `TheReactomeBook.pdf.zip`, `TheReactomeBook.rtf.zip`
- <a href="https://github.com/reactome/data-release-pipeline/tree/feature/download-directory/downloadDirectory#fetchtestreactomeontologyfiles">FetchTestReactomeOntologyFiles</a>: `reactome_data_model.pprj`, `reactome_data_model.pont`, `reactome_data_model.pins`
- <a href="https://github.com/reactome/data-release-pipeline/tree/feature/download-directory/downloadDirectory#createreleasetarball">CreateReleaseTarball</a>: `reactome.tar.gz`
- <a href="https://github.com/reactome/data-release-pipeline/tree/feature/download-directory/downloadDirectory#pathwaysummationmappingfile">PathwaySummationMappingFile</a>: `pathway2summation.txt`
- <a href="https://github.com/reactome/data-release-pipeline/tree/feature/download-directory/downloadDirectory#mapoldstableids">MapOldStableIds</a>: `reactome_stable_ids.txt`
- <a href="https://github.com/reactome/data-release-pipeline/tree/feature/download-directory/downloadDirectory#gene_associationreactome">gene_association.reactome</a>: `gene_association.reactome`
- <a href="https://github.com/reactome/data-release-pipeline/tree/feature/download-directory/downloadDirectory#models2pathways.tsv">models2pathways.tsv</a>: `models2pathways.tsv`
- <a href="https://github.com/reactome/data-release-pipeline/tree/feature/download-directory/downloadDirectory#createreactome2biosystems">CreateReactome2BioSystems</a>: `ReactomeToBioSystems.zip`

Files no longer generated by download directory include:
-  All `SBML` and `SBGN` files (generated elsewhere)
- `diagrams.pdf.zip` and `diagrams.png.zip`
- `curated_complex.txt` and `curated_complexes.stid.txt`
- `compiled_pathway_images` files
- `st_id_2_uniprot.txt`

<h3> Preparing and running Download Directory</h3>

To run the Download Directory step, a few things need to be taken into account.

<b> Local installation of the Pathway-Exchange dependancy</b>

Download Directory depends on a local installation of <a href="https://github.com/reactome/Pathway-Exchange">Pathway-Exchange</a>. This requires generating a new <b>ant</b> build of from <a href="https://github.com/reactome/Pathway-Exchange/blob/master/ant/PathwayExchangeJar.xml">PathwayExchangeJar.xml</a>. Most IDEs (Eclipse, IntelliJ) should be able to build the file (command-line methods will be added once found). This makes sure that the Data Model is up to date during the `BioPAX` step. If not updated, an unexpected data structure could cause the `BioPAX`, `GSEAOutput` or `CreateReactome2BioSystems` steps to fail. 

Once the jar file has been built, it should appear above the Pathway-Exchange directory in the `RESTfulAPI/web/WEB-INF/lib/` folder as `pathwayExchange.jar`. This jar file next needs to be installed locally in accordance with the <a href="https://github.com/reactome/data-release-pipeline/blob/feature/download-directory/downloadDirectory/pom.xml">POM file</a> in the DownloadDirectory repo.
<br><br>
Here is a sample snippet from the `pom.xml` file in Download Directory that contains the `Pathway-Exchange` information we care about:
```
<!-- Locally installed pathway exchange jar -->
  <dependency>
    <groupId>org.reactome.pathway-exchange</groupId>
    <artifactId>pathwayExchange</artifactId>
    <version>1.0.1</version>
  </dependency>
```

Based on the above information from the <a href="https://github.com/reactome/data-release-pipeline/blob/feature/download-directory/downloadDirectory/pom.xml">pom.xml</a> file, to locally install the `pathwayExchange.jar` we would use the following command:<br><br>
`mvn install:install-file -Dfile=pathwayExchange.jar -DgroupId=org.reactome.pathway-exchange -DartifactId=pathwayExchange -Dversion=1.0.1 -Dpackaging=jar`

If the build was successful, we have successfully installed an up-to-date `Pathway-Exchange` jar file that will be used by various steps during Download Directory.

<b> Setting config.properties </b>

Next the `config.properties` file must be set or updated in the `src/main/resources` folder. Below is a sample file:
```
## Sample config.properties file for Download Directory
username=mySQLUsername
password=mySQLPassword
database=test_reactome_67
host=localhost
port=3306
release=67
## Filepaths important to the Download Directory step
absoluteReleaseDirectoryPath=/usr/local/gkb/scripts/release/
releaseDownloadDirectoryPath=/usr/local/gkb/scripts/release/download_directory/
speciesConfigPath=src/main/resources/Species.json
stepsToRunConfigPath=src/main/resources/stepsToRun.config
```
<b> Running the program </b>

Now that the `Pathway-Exchange` project is accessible and the `config.properties` file set, the step can be run using the script runner <a href="https://github.com/reactome/data-release-pipeline/blob/feature/download-directory/downloadDirectory/runDownloadDirectory.sh">runDownloadDirectory.sh</a>.

<b>Note</b>: The `ReactomeBook` and `CreateReleaseTarball` steps still use the old Perl scripts found <a href="https://github.com/reactome/Release/tree/master/scripts/release/download_directory">here</a>. This means that, to generate the associated files, the Download Directory step will need to be run in either a docker container with the <a href="https://github.com/reactome/Release">Release</a> project usable, or on the release server. Download Directory can be run anywhere despite this, but if these steps aren't commented out in <a href="https://github.com/reactome/data-release-pipeline/blob/feature/download-directory/downloadDirectory/src/main/resources/stepsToRun.config">stepsToRun.config</a> (see below), they will report errors.
<br>

If the DownloadDirectory step has been run from the `release.pl` wrapper on the release server, the generated files would appear in `/usr/local/reactomes/Reactome/production/Website/static/download/67` if it was release 67. When the jar file is run directly, the files will appear in `/usr/local/gkb/scripts/release/download_directory/67`, again if it was release 67. 

<b> Running specific modules of Download Directory </b>

Specific files can be generated via the <a href="https://github.com/reactome/data-release-pipeline/blob/feature/download-directory/downloadDirectory/src/main/resources/stepsToRun.config">stepsToRun.config</a> file found in the `src/main/resources/` folder. This file contains a list of all steps that will be run during the Download Directory process.
Commenting out steps in this file will cause it to be excluded during the run. Sample below:
```
# This file is used to specify which steps in DownloadDirectory to execute.
# Comment out any steps that don't need to be run.
DatabaseDumps
#BioPAX2
BioPAX3
GSEAOutput
#ReactomeBookPDF
#ReactomeBookRTF
FetchTestReactomeOntologyFiles
#CreateReleaseTarball
PathwaySummationMappingFile
MapOldStableIds
gene_association.reactome
models2pathways.tsv
CreateReactome2BioSystems
```
In this example, the BioPAX2 and ReactomeBook steps will not be run. 

<h3> Verifying Download Directory Results</h3>

This section will touch on the files produced by each step in Download Directory, and how to verify they were produced correctly. Often, comparing the files produced in the previous release is the way to go, but where needed this guide will provide additional suggestions for checking the output.

After each step is run, the output files associated with the step are temporarily held in a folder corresponding to the current release. For release 67, the output files would appear in `data-release-pipeline/downloadDirectory/67`. 

<h4>DatabaseDumps</h4>

This step generates two mySQL dump files from the `stable_identifiers` database and the `test_reactome` database corresponding to the current release (eg: `test_reactome_67`). The files produced are `gk_stable_ids.sql.gz` and `gk_current.sql.gz`, respectively. These are then placed in the `data-release-pipeline/downloadDirectory/67/databases/` folder, if it was release 67. Comparing the size of these files to the previous release is sufficient for verifying the success of this step. 

<h4>BioPAX</h4>

This step generates BioPAX level 2 and level 3 `owl`and `xml` validation files for each species in the `test_reactome` database. Additional information on BioPAX can be found at it's <a href="http://www.biopax.org/">website</a>. This is typically the longest running step of a full Download Directory run, particularly due to the generation of the level 3 BioPAX files. It makes use of the `Pathway-Exchange` jar that should have been locally installed during the <a href="https://github.com/reactome/data-release-pipeline/tree/feature/download-directory/downloadDirectory#-preparing-and-running-download-directory">preparation</a> step of Download Directory.

<b>Note</b>: Due to the dependancy on a local installation of `Pathway-Exchange`, this is also the most error-prone step of Download Directory. Any `attribute` or `instance` errors that result from `BioPAX` might mean that this installation will need to be updated to the most recent <a href="https://github.com/reactome/Pathway-Exchange/blob/master/ant/PathwayExchangeJar.xml">version</a>. See above for instructions on installing/updating the `Pathway-Exchange` module. 

Each zip file produced should contain a number of files (`owl` or validation `xml`) corresponding to the species found in the <a href="https://github.com/reactome/data-release-pipeline/blob/feature/download-directory/downloadDirectory/src/main/resources/Species.json">Species.json</a> file.

`biopax2.zip` -- This zip file should contain a BioPAX <b>level 2</b> `owl` file for each species in `Species.json`. Ensure that the `owl` files pertain to `biopax-level2` by inspecting a few of the files. Looking at the corresponding validation files (found in `biopax2_validator.zip`) is also essential for determining if BioPAX level 2 ran correctly (see below).

`biopax.zip` -- This zip file should contain a BioPAX <b>level 3</b> `owl` file for each species in `Species.json`. Ensure that the `owl` files pertain to `biopax-level3` by inspecting a few of the files. Looking at the corresponding validation files (found in `biopax_validator.zip`) is also essential for determining if BioPAX level 3 ran correctly (see below). 

`biopax2_validator.zip` & `biopax_validator.zip` -- The  corresponding `validator.zip` file should contain a `validation.xml` file for each species that has an `owl` file in the `biopax.zip` file. These validation files can be quite large since they report problems at the `warning` and `error` levels, and historically there have been many warnings. Checking the `<validation description>` tag in the validation file will list the number of problems found, including any errors that might have come up. Any <b>errors</b> found will need to be investigated. Additionally, comparing the number of warnings between releases is another way to ensure that the BioPAX process ran successfully.

Additionally, a BioPAX validator tool exists <a href="http://biopax.baderlab.org/">online</a>. The `owl` files can be run through here as well to check validity.

<h4>GSEAOutput</h4>

This step uses the <a href="https://github.com/reactome/Pathway-Exchange/blob/master/src/org/reactome/gsea/ReactomeToMsigDBExport.java">ReactomeToMsigDBExport</a> method found in `Pathway-Exchange`. Ensure that the jar has been installed locally, as described in an earlier <a href="https://github.com/reactome/data-release-pipeline/tree/feature/download-directory/downloadDirectory#-preparing-and-running-download-directory">section</a> of this document. It takes all Human Pathway instances in the `test_reactome` database and converts the data to MSigDB format, which can be used in Gene Set Enrichment Analysis (GSEA). More information can be found at the GSEA <a href="http://software.broadinstitute.org/gsea/msigdb">website</a>. 

The `Reactome.gmt.zip` file produced is tab-seperated with <b>at least</b> 5 columns. The first few columns are the Pathway's `displayName` and `stableIdentifier` for the first 2, and the string `Reactome Pathway` for the third. This third column is added manually after initially generating the `Reactome.gmt` file. The remaining columns are all gene names that are associated with the pathway (needs confirmation). Each line in the file corresponds to a Human Pathway, but some entries are excluded due to missing attributes in the instance, meaning that the file should have nearly as many lines as Human Pathway instances in `test_reactome`. 

<h4>ReactomeBook</h4>
 
This step produces the `Reactome Book` in two filetypes: PDF and RTF (rich text format). Currently, this step still uses the Perl scripts found in Release (<a href="https://github.com/reactome/Release/blob/master/scripts/release/download_directory/genbook_pdf.pl">genbook_pdf.pl</a> and <a href="https://github.com/reactome/Release/blob/master/scripts/release/download_directory/genbook_rtf.pl">genbook_rtf.pl</a>). There are plans to update this scripts but there is no timeline at time of writing (December 2018). 

Once the step completes, the first check would be to compare the file sizes between releases. They should differ but still be relatively close to each other. Next, make sure each file can open on your computer and inspect the contents. 

`TheReactomeBook.pdf.zip`: Check that the table of contents exists and that diagrams are visible (both EHLD and pathway diagrams). Check the end of the book to make sure that it ends at an appropriate point (typically it would end after the final Pathway instance, meaning that the final page should be <b>References</b>). You can also look at the end of the PDF file and see that the proper end-of-file character is present: `%%EOF`

`TheReactomeBook.rtf.zip`: The zip file should contain a number of RTF files. Excluding the first file, `0.rtf` (which is introductory information), these files should correspond to the number of `top-level pathways` in Reactome. This can be confirmed by opening up an instance of <a href="https://reactome.org/download-data/reactome-curator-tool">CuratorTool</a> that points to the current `test_reactome` database and looking at the single `FrontPage` instance. This has an attribute, `frontPageItem`, that contains an array of all `top-level pathways`. The number of `top-level pathways` in this array should be equal to the number of RTF files (excluding the `0.rtf` file). Additionally, make sure that there are EHLD and pathway diagrams. The RTF book does not contain a table of contents. 

<h4>FetchTestReactomeOntologyFiles</h4>

This step produces 3 different files, `reactome_data_model.pprj`, `reactome_data_model.pont`, and `reactome_data_model.pins`. All are parsed from the `ontology` attribute in the `Ontology` table in `test_reactome`. This value in `Ontology.ontology` is a blob that contains all 3 files in it's contents. These 3 files are parsed out of the blob during the FetchTestReactomeOntologyFiles step. These files are associated with Protégé 2.0 (<a href="https://protege.stanford.edu/">website</a>). These files can be used with Protégé software. Additional information about each filetype can be found <a href="https://protegewiki.stanford.edu/wiki/PrF_UG_files_protege_files">here</a>.

Compare each file with it's equivalent from the previous release. The beginning and end of each file should have the same formatting between them, although the content may differ. 

<h4>CreateReleaseTarball</h4>

The file produced by this step, `reactome.tar.gz`, is an archive that acts as a snapshot of the <a href="https://github.com/reactome/Release">Release</a> repo and some aspects of the release server. 
The tar file contains the following:

- From the Release <b>repo</b>:
   - The contents of the `website/` folder
   - The contents of the `modules/` folder
   - The contents `etc/` and `usr/` folders in the  `third_party_install/` folder (stored as `config.tar.gz`)
- From the Release <b>server</b>:
  - The `analysis.bin` file generated during Release
  
 Some of the archiving doesn't take place due to the filepaths changing (this will be updated). The following are files/folders that the script attempts to archive but, at time of writing, has been unable to locate the file(s):

- Solr indexes, apache-tomcat folder, pathway diagrams and fireworks files

To check the tarball, compare it with the one generated during the previous release. The sizes should be fairly similar.

<h4>PathwaySummationMappingFile</h4>
 
This step creates a tab-seperated file, `pathway2summation.txt`. The file contains information on all Human Pathways in `test_reactome`. The 3 columns of the file are `stableIdentifier`, `name`, and `summation`, and are populated from the Pathway instances attributes of the same name. 

The file should have the same amount of lines as Human Pathway instances in `test_reactome`. 

<h4>MapOldStableIds</h4>

This step will match old `stableIdentifiers` to ones in the new format. The file contains two tab-seperated columns of stable IDs in the new (eg: `R-HSA-1234567`) and old (eg: `REACT_98765`) formats. The file should include stableIdentifiers for <b>all</b> species in Reactome, and should have approximately the same number of lines as `stableIdentifier` instances in `test_reactome`.

<h4>gene_association.reactome</h4>

This step copies the `gene_association.reactome` file that is produced during the <a href="https://github.com/reactome/Release/tree/master/scripts/release/goa_prepare">Goa Prepare</a> step. Comparing the file to previous releases is sufficient for this step.

<h4>models2pathways.tsv</h4>

This step copes the `models2pathways.tsv` file that is produced during the <a href="https://github.com/reactome/Release/tree/master/scripts/release/biomodels">Biomodels</a> step. Comparing the file to previous releases is sufficient for this step.

<h4>CreateReactome2BioSystems</h4>

This step creates a zip file containing an NCBI BioSystems-formatted `xml` file for each of Reactome's primary model organisms. More information on NCBI BioSystems is found at the <a href="https://www.ncbi.nlm.nih.gov/biosystems/">website</a>.

This module uses the <a href="https://github.com/reactome/Pathway-Exchange/blob/master/src/org/gk/biosystems/ReactomeToBioSystemsConverter.java">ReactomeToBioSystemsConverter</a> method in `Pathway-Exchange`. Ensure that the jar has been installed locally, as described in an earlier <a href="https://github.com/reactome/data-release-pipeline/tree/feature/download-directory/downloadDirectory#-preparing-and-running-download-directory">section</a> of this document. 

Compare the files produced with those from an earlier release for verification the process ran successfully. 







