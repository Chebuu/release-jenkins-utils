<h2>Download Directory</h2>

The `Download Directory` step generates a number of files that can be downloaded from Reactome's <a href="https://reactome.org/download-data">download page</a>. It also generates an archive file during the `CreateReleaseTarball` step that acts as a snapshot of the <a href="https://github.com/reactome/Release">Release repository</a> and release server. This module has been rewritten from Perl to Java. 
<br><br>The steps of `DownloadDirectory` and files produced are:

- <a href="https://github.com/reactome/data-release-pipeline/tree/feature/download-directory/downloadDirectory#DatabaseDumps">DatabaseDumps</a>: `gk_stable_ids.sql` (stable_identifiers), `gk_current.sql` (test_reactome)
- BioPAX: `biopax2.zip`, `biopax2_validator.zip`, `biopax.zip`, `biopax_validator.zip`
- GSEAOutput: `ReactomePathways.gmt.zip`
- ReactomeBook: `TheReactomeBook.pdf.zip`, `TheReactomeBook.rtf.zip`
- FetchTestReactomeOntologyFiles: `reactome_data_model.pprj`, `reactome_data_model.pont`, `reactome_data_model.pins`
- CreateReleaseTarball: `reactome.tar.gz`
- PathwaySummationMappingFile: `pathway2summation.txt`
- MapOldStableIds: `reactome_stable_ids.txt`
- gene_association.reactome: `gene_association.reactome`
- models2pathways.tsv: `models2pathways.tsv`
- CreateReactome2BioSystems: `ReactomeToBioSystems.zip`

Files no longer generated by download directory include:
-  All `SBML` and `SBGN` files (generated elsewhere)
- `diagrams.pdf.zip` and `diagrams.png.zip`
- `curated_complex.txt` and `curated_complexes.stid.txt`
- `compiled_pathway_images` files
- `st_id_2_uniprot.txt`

<h3> Preparing and running Download Directory</h3>

To run the download directory step, a few things need to be taken into account.

<b> Local installation of the Pathway-Exchange dependancy</b>

DownloadDirectory depends on a local installation of <a href="https://github.com/reactome/Pathway-Exchange">Pathway-Exchange</a>. This requires generating a new <b>ant</b> build of from <a href="https://github.com/reactome/Pathway-Exchange/blob/master/ant/PathwayExchangeJar.xml">PathwayExchangeJar.xml</a>. Most IDEs (Eclipse, IntelliJ) should be able to build the file (command-line methods will be added once found). This makes sure that the Data Model is up to date during the `BioPAX` step. If not updated, an unexpected data structure can cause the `BioPAX` step to fail. 

Once the jar file has been built, it should appear above the Pathway-Exchange directory in the `RESTfulAPI/web/WEB-INF/lib/` folder as `pathwayExchange.jar`. This jar file next needs to be installed locally in accordance with the <a href="https://github.com/reactome/data-release-pipeline/blob/feature/download-directory/downloadDirectory/pom.xml">POM file</a> in the DownloadDirectory repo.
<br><br>
Here is a sample snippet from the `pom.xml` file that contains the `Pathway-Exchange` information we care about:
```
<!-- Locally installed pathway exchange jar -->
  <dependency>
    <groupId>org.reactome.pathway-exchange</groupId>
    <artifactId>pathwayExchange</artifactId>
    <version>1.0.1</version>
  </dependency>
```

Based on the above information from the <a href="https://github.com/reactome/data-release-pipeline/blob/feature/download-directory/downloadDirectory/pom.xml">pom.xml</a> file, to locally install the `pathwayExchange.jar` we would use the following command:<br><br>
`mvn install:install-file -Dfile=pathwayExchange.jar -DgroupId=org.reactome.pathway-exchange -DartifactId=pathwayExchange -Dversion=1.0.1 -Dpackaging=jar`

If the build was successful, we have successfully installed an up-to-date `Pathway-Exchange` jar file that will be used by the `DownloadDirectory` step.

<b> Setting config.properties </b>

Next the `config.properties` file must be set or updated in the `src/main/resources` folder. Below is a sample file:
```
## Sample config.properties file for Download Directory
username=mySQLUsername
password=mySQLPassword
database=test_reactome_67
host=localhost
port=3306
release=67
## Filepaths important to the Download Directory step
absoluteReleaseDirectoryPath=/usr/local/gkb/scripts/release/
releaseDownloadDirectoryPath=/usr/local/gkb/scripts/release/download_directory/
speciesConfigPath=src/main/resources/Species.json
stepsToRunConfigPath=src/main/resources/stepsToRun.config
```
<b> Running the program </b>

Now that the `Pathway-Exchange` project is accessible and the `config.properties` file set, the step can be run using the script runner <a href="https://github.com/reactome/data-release-pipeline/blob/feature/download-directory/downloadDirectory/runDownloadDirectory.sh">runDownloadDirectory.sh</a>.

<b>Note</b>: The `ReactomeBook` and `CreateReleaseTarball` steps still use the old Perl scripts found <a href="https://github.com/reactome/Release/tree/master/scripts/release/download_directory">here</a>. This means that, to generate the associated files, the `Download Directory` step will need to be run in either a docker container with the <a href="https://github.com/reactome/Release">Release</a> project usable, or on the release server. `Download Directory` can be run anywhere despite this, but if these steps aren't commented out in <a href="https://github.com/reactome/data-release-pipeline/blob/feature/download-directory/downloadDirectory/src/main/resources/stepsToRun.config">stepsToRun.config</a> (see below), they will report errors.
<br>

<b> Running specific modules of Download Directory </b>

Specific files can be generated via the <a href="https://github.com/reactome/data-release-pipeline/blob/feature/download-directory/downloadDirectory/src/main/resources/stepsToRun.config">stepsToRun.config</a> file found at `src/main/resources`. This file contains a list of all steps that will be run during the `Download Directory` process.
Commenting out steps in this file will cause it to be excluded during the run. Sample below:
```
# This file is used to specify which steps in DownloadDirectory to execute.
# Comment out any steps that don't need to be run.
DatabaseDumps
#BioPAX2
BioPAX3
GSEAOutput
#ReactomeBookPDF
#ReactomeBookRTF
FetchTestReactomeOntologyFiles
#CreateReleaseTarball
PathwaySummationMappingFile
MapOldStableIds
gene_association.reactome
models2pathways.tsv
CreateReactome2BioSystems
```
In this example, the BioPAX level 2 and ReactomeBook steps will not be run and subsequently the files not produced. 

<h3> Verifying Download Directory Results</h3>

This section will touch on what the files produced by each step in `Download Directory` are, and how to verify they were produced correctly. Often, comparing the files produced in the previous release is the way to go, but where needed this guide will provide additional suggestions for checking the output.

After each step is run, the output files associated with the step are moved to a folder corresponding to the current release. For release 67, the output files would appear in `data-release-pipeline/downloadDirectory/67`. 

<h4>DatabaseDumps</h4>

This step generates two mySQL dump files from the `stable_identifiers` database and the `test_reactome` database corresponding to the current release (eg: `test_reactome_67`). The files produced are `gk_stable_ids.sql.gz` and `gk_current.sql.gz`, respectively. These are then placed in the `databases/` folder. Comparing the size of these files to the previous release is sufficient for verifying the success of this step. 

<h4>BioPAX</h4>

This step generates BioPAX level 2 and level 3 `owl`and `xml` validation files for each species in the `test_reactome` database. Additional information on BioPAX can be found at it's <a href="http://www.biopax.org/">website</a>. This is typically the longest running step of a full `DownloadDirectory` run, particularly due to the generation of the level 3 files. It makes use of the `Pathway-Exchange` jar that should have been locally installed during the <a href="https://github.com/reactome/data-release-pipeline/tree/feature/download-directory/downloadDirectory#-preparing-and-running-download-directory">preparation</a> step of DownloadDirectory.

<b>Note</b>: Due to the dependancy on a local installation of `Pathway-Exchange`, this is also the most error-prone step of `DownloadDirectory`. Any `attribute` or `instance` errors that result from `BioPAX` might mean that this installation will need to be updated to the most recent <a href="https://github.com/reactome/Pathway-Exchange/blob/master/ant/PathwayExchangeJar.xml">version</a>. See above for instructions on installing/updating the `Pathway-Exchange` module. 

Each zip file produced should contain a number of files (`owl` or validation `xml`) corresponding to the species found in the <a href="https://github.com/reactome/data-release-pipeline/blob/feature/download-directory/downloadDirectory/src/main/resources/Species.json">Species.json</a> file.

`biopax2.zip` -- This zip file should contain a BioPAX <b>level 2</b> `owl` file for each species in `Species.json`. Ensure that the `owl` files pertain to `biopax-level2` by inspecting a few of the files. Looking at the corresponding validation files (found in `biopax2_validator.zip`) is also essential for determining if BioPAX level 2 ran correctly (see below).

`biopax.zip` -- This zip file should contain a BioPAX <b>level 3</b> `owl` file for each species in `Species.json`. Ensure that the `owl` files pertain to `biopax-level3` by inspecting a few of the files. Looking at the corresponding validation files (found in `biopax_validator.zip`) is also essential for determining if BioPAX level 3 ran correctly (see below). 

`biopax2_validator.zip` & `biopax_validator.zip` -- The  corresponding `validator.zip` file should contain a `validation.xml` file for each species that has an `owl` file in the `biopax.zip` file. These validation files can be quite large since they report problems at the `warning` and `error` levels, and historically there have been many warnings. Checking the `<validation description>` tag in the validation file will list the number of problems found, including any errors that might have come up. Any errors found will need to be investigated. Additionally, comparing the number of warnings between releases is another way to ensure that the BioPAX process ran successfully.

Finally, a BioPAX validator tool exists <a href="http://biopax.baderlab.org/">online</a>. The `owl` files can be run through here as well to check validity.











